<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0"
    />
    <title>Color Compass</title>
    <link rel="stylesheet" href="css/style.css" />

    <!-- Import Map to resolve bare module specifiers like "three" -->
    <!-- MUST be before any script type="module" that imports these -->
    <script type="importmap">
      {
        "imports": {
          "three": "./lib/three/build/three.module.js",
          "three/addons/": "./lib/three/examples/jsm/"
        }
      }
    </script>

    <!-- Import Three.js and OrbitControls as ES Modules -->
    <!-- These rely on the importmap above to resolve their internal 'three' and 'three/addons/' imports -->
    <script type="module" src="lib/three/build/three.module.js"></script>
    <script
      type="module"
      src="lib/three/examples/jsm/controls/OrbitControls.js"
    ></script>

    <!-- Import local JavaScript modules -->
    <!-- The order here matters for dependency loading, but browsers handle it with modules -->
    <!-- main.js should technically be the last script in the body for DOMContentLoaded, but putting it last here is also fine -->
    <script type="module" src="js/colorUtils.js"></script>
    <script type="module" src="js/imageHandler.js"></script>
    <script type="module" src="js/medianCut.js"></script>
    <script type="module" src="js/paletteAnalyzer.js"></script>
    <script type="module" src="js/paletteRenderer.js"></script>
    <script type="module" src="js/colorStats.js"></script>
    <script type="module" src="js/visualization2D.js"></script>
    <script type="module" src="js/visualizationAdvanced.js"></script>
    <script type="module" src="js/sphereRenderer3D.js"></script>
    <script type="module" src="js/fileSaver.js"></script>
    <script type="module" src="js/i18n.js"></script>
    <script type="module" src="js/main.js"></script>
  </head>
  <body>
    <div class="language-switcher">
      <button id="langZH" class="lang-btn" data-lang="zh-CN">中文</button>
      <button id="langEN" class="lang-btn active" data-lang="en-US">EN</button>
    </div>
    <div class="content-wrapper">
      <h1>Color Compass</h1>

      <div class="input-section">
        <div id="uploadArea" class="upload-area">
          <div class="upload-instructions">
            <p data-i18n="upload.dragHint"></p>
            <label for="imageInput" class="file-input-label">
              <span data-i18n="upload.selectButton"></span>
              <input type="file" id="imageInput" accept="image/*" />
            </label>
            <p class="paste-hint"><span data-i18n="upload.pasteHint"></span></p>
          </div>
        </div>
      </div>

      <div class="image-display" id="imageDisplay">
        <button class="remove-image-btn" id="removeImageBtn" title="" data-i18n="upload.removeButton" data-i18n-attr="title">×</button>
        <img id="uploadedImage" src="#" alt="Uploaded Image" />
      </div>

      <!-- Hidden Canvas used to get pixel data -->
      <canvas id="hiddenCanvas" style="display: none"></canvas>

      <div class="dashboard-container">
        <div class="left-panel">
          <div class="palette-section">
            <h2><span data-i18n="palette.title" data-i18n-attr="textContent"></span></h2>
            <div class="palette-controls">
              <button id="reRenderPaletteBtn"><span data-i18n="palette.reRenderButton" data-i18n-attr="textContent"></span></button>
              <button id="resetParamsBtn" style="margin-left: 10px;"><span data-i18n="palette.resetParamsButton" data-i18n-attr="textContent"></span></button>
              <div class="palette-params">
                <div class="params-basic">
                  <h3><span data-i18n="palette.basicParams" data-i18n-attr="textContent"></span></h3>
                  <div class="param-group">
                    <label for="dominantColors"
                      ><span data-i18n="palette.labels.dominantColors" data-i18n-attr="textContent"></span>
                      <span class="tooltip">?<span class="tooltiptext" data-i18n-key="palette.tooltips.dominantColors"></span></span>
                    </label>
                    <input
                      type="range"
                      id="dominantColors"
                      min="2"
                      max="20"
                      value="8"
                    />
                    <span class="param-value" id="dominantColorsValue">8</span>
                  </div>
                </div>
                <div class="params-advanced">
                  <button id="toggleAdvancedBtn"><span data-i18n="palette.showAdvanced" data-i18n-attr="textContent"></span></button>
                  <div class="advanced-content" style="display: none">
                    <div class="param-group">
                      <label for="paletteSize"
                        ><span data-i18n="palette.labels.paletteSize" data-i18n-attr="textContent"></span>
                        <span class="tooltip">?<span class="tooltiptext" data-i18n-key="palette.tooltips.paletteSize"></span></span>
                      </label>
                      <input
                        type="range"
                        id="paletteSize"
                        min="2"
                        max="50"
                        value="20"
                      />
                      <span class="param-value" id="paletteSizeValue">20</span>
                    </div>

                    <div class="param-group">
                      <label for="maxHiddenColors"
                        ><span data-i18n="palette.labels.maxHiddenColors" data-i18n-attr="textContent"></span>
                        <span class="tooltip">?<span class="tooltiptext" data-i18n-key="palette.tooltips.maxHiddenColors"></span></span>
                      </label>
                      <input
                        type="range"
                        id="maxHiddenColors"
                        min="0"
                        max="5"
                        value="2"
                        step="1"
                      />
                      <span class="param-value" id="maxHiddenColorsValue">2</span>
                    </div>
                    <div class="param-group">
                      <label for="minHiddenPercentage"
                        ><span data-i18n="palette.labels.minHiddenPercentage" data-i18n-attr="textContent"></span>
                        <span class="tooltip">?<span class="tooltiptext" data-i18n-key="palette.tooltips.minHiddenPercentage"></span></span>
                      </label>
                      <input
                        type="range"
                        id="minHiddenPercentage"
                        min="0"
                        max="0.5"
                        value="0.01"
                        step="0.005"
                      />
                      <span class="param-value" id="minHiddenPercentageValue">0.01</span>
                    </div>
                    <div class="param-group">
                      <label for="superpixelCount"
                        ><span data-i18n="palette.labels.superpixelCount" data-i18n-attr="textContent"></span>
                        <span class="tooltip">?<span class="tooltiptext" data-i18n-key="palette.tooltips.superpixelCount"></span></span>
                      </label>
                      <input
                        type="range"
                        id="superpixelCount"
                        min="50"
                        max="500"
                        value="200"
                        step="10"
                      />
                      <span class="param-value" id="superpixelCountValue">200</span>
                    </div>
                    <div class="param-group">
                      <label for="superpixelCompactness"
                        ><span data-i18n="palette.labels.superpixelCompactness" data-i18n-attr="textContent"></span>
                        <span class="tooltip">?<span class="tooltiptext" data-i18n-key="palette.tooltips.superpixelCompactness"></span></span>
                      </label>
                      <input
                        type="range"
                        id="superpixelCompactness"
                        min="1"
                        max="50"
                        value="10"
                        step="1"
                      />
                      <span class="param-value" id="superpixelCompactnessValue">10</span>
                    </div>
                    <div class="param-group">
                      <label for="backgroundVarianceScale"
                        ><span data-i18n="palette.labels.backgroundVarianceScale" data-i18n-attr="textContent"></span>
                        <span class="tooltip">?<span class="tooltiptext" data-i18n-key="palette.tooltips.backgroundVarianceScale"></span></span>
                      </label>
                      <input
                        type="range"
                        id="backgroundVarianceScale"
                        min="0.5"
                        max="10.0"
                        value="1.0"
                        step="0.1"
                      />
                      <span class="param-value" id="backgroundVarianceScaleValue">1.0</span>
                    </div>
                    <div class="param-group">
                      <label for="maxBackgrounds"
                        ><span data-i18n="palette.labels.maxBackgrounds" data-i18n-attr="textContent"></span>
                        <span class="tooltip">?<span class="tooltiptext" data-i18n-key="palette.tooltips.maxBackgrounds"></span></span>
                      </label>
                      <input
                        type="range"
                        id="maxBackgrounds"
                        min="1"
                        max="5"
                        value="3"
                        step="1"
                      />
                      <span class="param-value" id="maxBackgroundsValue">3</span>
                    </div>
                    <div class="param-group">
                      <label for="useDeltaE"
                        ><span data-i18n="palette.labels.useDeltaE" data-i18n-attr="textContent"></span>
                        <span class="tooltip">?<span class="tooltiptext" data-i18n-key="palette.tooltips.useDeltaE"></span></span>
                      </label>
                      <input
                        type="checkbox"
                        id="useDeltaE"
                      />
                      <span class="param-value" id="useDeltaEValue"><span data-i18n="palette.labels.deltaEOff" data-i18n-attr="textContent"></span></span>
                    </div>
                  </div>
                </div>
              </div>
              <canvas id="paletteCanvas"></canvas>
              <p id="palettePlaceholder"><span data-i18n="palette.placeholder" data-i18n-attr="textContent"></span></p>
              <div class="export-buttons">
                <!-- Export buttons for palette -->
                <button id="savePaletteImageBtn"><span data-i18n="palette.export.image" data-i18n-attr="textContent"></span></button>
                <button id="savePaletteDataBtn"><span data-i18n="palette.export.data" data-i18n-attr="textContent"></span></button>
              </div>
            </div>
          </div>

          <div class="color-sphere-section">
            <h2><span data-i18n="palette.colorSpace" data-i18n-attr="textContent"></span></h2>
            <div id="sphereContainer">
              <!-- Three.js will render its canvas here -->
            </div>
            <p id="spherePlaceholder"><span data-i18n="palette.spherePlaceholder" data-i18n-attr="textContent"></span></p>
            <div class="export-buttons">
              <!-- Export button for 3D sphere -->
              <button id="saveSphereImageBtn"><span data-i18n="palette.sphereExport" data-i18n-attr="textContent"></span></button>
            </div>
          </div>
        </div>

        <div class="right-panel">
          <div class="color-analysis-section">
            <h2><span data-i18n="analysis.title" data-i18n-attr="textContent"></span><span class="tooltip">?<span class="tooltiptext" data-i18n-key="analysis.tooltip"></span></span></h2>

            <h3><span data-i18n="analysis.stats" data-i18n-attr="textContent"></span></h3>
            <div class="stats-summary">
              <p id="hsvStats"></p>
              <p id="labStats"></p>
            </div>

            <div class="histograms-2d-viz">
              <h3><span data-i18n="analysis.distribution" data-i18n-attr="textContent"></span></h3>
              <div class="histograms-container">
                <div class="chart-container">
                  <canvas id="histH" role="img" aria-label="Hue distribution histogram"></canvas>
                  <p data-i18n="analysis.histograms.hue" data-i18n-attr="textContent"></p>
                </div>
                <div class="chart-container">
                  <canvas id="histS" role="img" aria-label="Saturation distribution histogram"></canvas>
                  <p data-i18n="analysis.histograms.saturation" data-i18n-attr="textContent"></p>
                </div>
                <div class="chart-container">
                  <canvas id="histV" role="img" aria-label="Value distribution histogram"></canvas>
                  <p data-i18n="analysis.histograms.value" data-i18n-attr="textContent"></p>
                </div>
                <div class="chart-container">
                  <canvas id="histL" role="img" aria-label="L* luminance distribution histogram"></canvas>
                  <p data-i18n="analysis.histograms.luminance" data-i18n-attr="textContent"></p>
                </div>
                <div class="chart-container">
                  <canvas id="hista" role="img" aria-label="a* Red-Green axis distribution histogram"></canvas>
                  <p data-i18n="analysis.histograms.aAxis" data-i18n-attr="textContent"></p>
                </div>
                <div class="chart-container">
                  <canvas id="histb" role="img" aria-label="b* Yellow-Blue axis distribution histogram"></canvas>
                  <p data-i18n="analysis.histograms.bAxis" data-i18n-attr="textContent"></p>
                </div>
              </div>

            <!-- 高级可视化图表 - 2x2网格布局 -->
              <div class="advanced-viz-section" id="advancedVizSection">
                <h2><span data-i18n="advanced.title" data-i18n-attr="textContent"></span><span class="tooltip">?<span class="tooltiptext" data-i18n-key="advanced.tooltip"></span></span></h2>
                <div class="advanced-charts-grid four-charts">
                  <div class="chart-container">
                    <canvas id="huePolar" width="400" height="400" role="img" aria-label="Hue polar distribution chart showing hue distribution density on circle"></canvas>
                    <p><span data-i18n="advanced.charts.huePolar.title" data-i18n-attr="textContent"></span><span class="tooltip">?<span class="tooltiptext" data-i18n-key="advanced.charts.huePolar.tooltip"></span></span></p>
                  </div>
                  <div class="chart-container">
                    <canvas id="labScatter" width="400" height="400" role="img" aria-label="Lab a*b* scatter plot, horizontal axis a* Red-Green, vertical axis b* Yellow-Blue"></canvas>
                    <p><span data-i18n="advanced.charts.labScatter.title" data-i18n-attr="textContent"></span><span class="tooltip">?<span class="tooltiptext" data-i18n-key="advanced.charts.labScatter.tooltip"></span></span></p>
                  </div>
                  <div class="chart-container">
                    <canvas id="distanceHeatmap" width="400" height="400" role="img" aria-label="Color distance heatmap showing color difference for each region to nearest palette color"></canvas>
                    <p><span data-i18n="advanced.charts.distanceHeatmap.title" data-i18n-attr="textContent"></span><span class="tooltip">?<span class="tooltiptext" data-i18n-key="advanced.charts.distanceHeatmap.tooltip"></span></span></p>
                  </div>
                  <div class="chart-container">
                    <canvas id="labDensity" width="400" height="400" role="img" aria-label="Lab color density distribution chart showing color density on a*b* plane"></canvas>
                    <p><span data-i18n="advanced.charts.labDensity.title" data-i18n-attr="textContent"></span><span class="tooltip">?<span class="tooltiptext" data-i18n-key="advanced.charts.labDensity.tooltip"></span></span></p>
                  </div>
                </div>
              </div>

              <!-- 移除原来的lab-scatter-section，它已经移到高级图表区域 -->
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- End of content-wrapper -->

    <!-- Note: Script tags with type="module" do not need to be at the end of body. -->
    <!-- They have 'defer' behavior by default. -->

    <footer>
      <div>
        <a
          href="https://github.com/AkutaZehy/color-compass"
          target="_blank"
          data-i18n="footer.github" data-i18n-attr="textContent"
        ></a>
        <br />
        <span data-i18n="footer.privacy" data-i18n-attr="textContent"></span>
      </div>
    </footer>
  </body>
</html>
